name: Build and Test Container

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      name: Checkout code

    - name: Install PHP and dependencies
      run: sudo apt-get update && sudo apt-get install php php-mbstring php-xml

    - name: Install Composer dependencies
      run: composer install --no-interaction --prefer-dist --optimize-autoloader

    - name: Build Docker image
      run: docker build . -t laravel-web-app

    - name: Run Docker container
      run: docker run -d -p 80:80 --hostname testing.com --name laravel-container laravel-web-app

    - name: list containers
      run: docker ps

    - name: Get container logs
      run: docker logs laravel-container

    - name: Check if container is up
      run: |
        for i in {1..10}; do
          if curl http://localhost\?code=OK; then
            echo "Endpoint is up!"
            exit 0
          else
            echo "Waiting for endpoint to be up..."
            sleep 5
          fi
        done
        echo "Endpoint did not respond in time."
        exit 1